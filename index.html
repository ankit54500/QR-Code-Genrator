<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Generator Pro</title>
    
    <!-- Supabase -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.0/umd/supabase.min.js"></script>
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    
    <!-- Razorpay -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #1a1d29;
            --bg-card: #262b3f;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --success: #10b981;
            --premium: #f59e0b;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.25);
            --error: #ef4444;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --success: #10b981;
            --premium: #f59e0b;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --error: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .navbar {
            background: var(--bg-card);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--premium));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .theme-toggle {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
        }

        .theme-toggle:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 3rem;
            align-items: start;
        }

        .pricing-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px var(--shadow);
            position: sticky;
            top: 120px;
            border: 1px solid var(--border);
        }

        .plan-selector {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .plan-option {
            padding: 2rem;
            border: 2px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .plan-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .plan-option:hover::before {
            left: 100%;
        }

        .plan-option:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }

        .plan-option.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(245, 158, 11, 0.1));
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.2);
        }

        .plan-free.selected {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.2);
        }

        .plan-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            background: var(--premium);
            color: var(--bg-primary);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: bold;
            transform: rotate(12deg);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .plan-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .plan-price {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
            margin-bottom: 1.5rem;
        }

        .plan-features {
            list-style: none;
            padding: 0;
        }

        .plan-features li {
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 0.95rem;
        }

        .plan-features li::before {
            content: '‚úì';
            color: var(--success);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .main-content {
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px var(--shadow);
            border: 1px solid var(--border);
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--accent), var(--premium));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 1rem 1.2rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        .form-group textarea {
            resize: vertical;
            height: 120px;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            color: white;
            border: none;
            padding: 1.2rem 2.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.1rem;
            width: 100%;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(99, 102, 241, 0.4);
        }

        .btn:disabled {
            background: var(--border);
            cursor: not-allowed;
            transform: none;
        }

        .btn-premium {
            background: linear-gradient(135deg, var(--premium), #d97706);
        }

        .btn-premium:hover:not(:disabled) {
            box-shadow: 0 15px 35px rgba(245, 158, 11, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid transparent;
            border-top: 3px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            margin-top: 3rem;
            padding: 2.5rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(245, 158, 11, 0.1));
            border-radius: 20px;
            border: 1px solid var(--success);
            backdrop-filter: blur(10px);
        }

        .link-item {
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .link-text {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            word-break: break-all;
            background: var(--bg-primary);
            padding: 1.2rem;
            border-radius: 10px;
            margin: 1rem 0;
            border: 1px solid var(--border);
        }

        .qr-container {
            text-align: center;
            margin-top: 3rem;
        }

        .qr-code {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            display: inline-block;
            margin: 1.5rem 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
        }

        .share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        .share-btn {
            padding: 1rem 2rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }

        .whatsapp-btn {
            background: #25d366;
            color: white;
        }

        .email-btn {
            background: #0ea5e9;
            color: white;
        }

        .toast {
            position: fixed;
            top: 120px;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1.2rem 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow);
            transform: translateX(400px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            font-weight: 600;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--error);
        }

        .hidden {
            display: none;
        }

        .expiry-info {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            text-align: center;
            font-weight: 600;
            border: 1px solid var(--border);
        }

        .viewer-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .viewer-card {
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 20px 60px var(--shadow);
            border: 1px solid var(--border);
        }

        .entry-title {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--premium));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            word-break: break-word;
            text-align: center;
        }

        .entry-description {
            font-size: 1.2rem;
            line-height: 1.8;
            color: var(--text-primary);
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 16px;
            white-space: pre-wrap;
            border: 1px solid var(--border);
        }

        .entry-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .meta-item {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .meta-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .meta-value {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .file-section {
            margin: 2rem 0;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .file-link {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 1.2rem 2.5rem;
            background: linear-gradient(135deg, var(--success), #059669);
            border-radius: 50px;
            transition: all 0.3s ease;
        }

        .file-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.3);
        }

        .actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            justify-content: center;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
            gap: 2rem;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error-container {
            text-align: center;
            padding: 4rem 2rem;
        }

        .error-icon {
            font-size: 5rem;
            margin-bottom: 2rem;
        }

        .error-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--error);
            margin-bottom: 1rem;
        }

        .error-message {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 1rem;
            }

            .pricing-card {
                position: static;
            }

            .share-buttons {
                grid-template-columns: 1fr;
            }

            .navbar {
                padding: 1rem;
            }

            .entry-title {
                font-size: 2.2rem;
            }

            .toast {
                right: 1rem;
                left: 1rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo" onclick="goHome()">QR Generator Pro</div>
        <button class="theme-toggle" id="themeToggle">
            <span id="themeIcon">üåô</span>
            <span id="themeText">Dark Mode</span>
        </button>
    </nav>

    <!-- Create Mode -->
    <div id="createMode">
        <div class="container">
            <!-- Pricing Section -->
            <div class="pricing-card">
                <h2 style="margin-bottom: 2rem; color: var(--accent); font-size: 1.8rem; font-weight: 700;">Choose Your Plan</h2>
                
                <div class="plan-selector">
                    <div class="plan-option plan-free selected" data-plan="free">
                        <div class="plan-title" style="color: var(--success);">Free Plan</div>
                        <div class="plan-price">‚Çπ0</div>
                        <ul class="plan-features">
                            <li>24 hours validity</li>
                            <li>Basic QR code</li>
                            <li>View + Edit links</li>
                            <li>WhatsApp sharing</li>
                            <li>Email sharing</li>
                        </ul>
                    </div>

                    <div class="plan-option plan-premium" data-plan="premium">
                        <div class="plan-badge">POPULAR</div>
                        <div class="plan-title" style="color: var(--premium);">Premium Plan</div>
                        <div class="plan-price">‚Çπ15</div>
                        <ul class="plan-features">
                            <li>30 days validity</li>
                            <li>Custom QR styling</li>
                            <li>Priority support</li>
                            <li>Advanced analytics</li>
                            <li>WhatsApp auto-send</li>
                            <li>Email auto-send</li>
                            <li>PDF download</li>
                            <li>No watermark</li>
                        </ul>
                    </div>
                </div>

                <div id="selectedPlanInfo" class="expiry-info">
                    <strong>Selected:</strong> Free Plan (24 hours)
                </div>
            </div>

            <!-- Main Form -->
            <div class="main-content">
                <h1 class="section-title">Create QR Entry</h1>
                
                <form id="dataForm">
                    <div class="form-group">
                        <label for="title">Entry Title *</label>
                        <input type="text" id="title" name="title" required maxlength="100" placeholder="e.g., My Business Card, Event Details">
                    </div>

                    <div class="form-group">
                        <label for="description">Description *</label>
                        <textarea id="description" name="description" required maxlength="2000" placeholder="Enter detailed information about your QR entry..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="number">Contact Number</label>
                        <input type="tel" id="number" name="number" placeholder="+91 9876543210">
                    </div>

                    <div class="form-group">
                        <label for="fileUrl">File/Website URL</label>
                        <input type="url" id="fileUrl" name="fileUrl" placeholder="https://example.com/document.pdf">
                    </div>

                    <button type="submit" class="btn" id="submitBtn">
                        <span id="submitText">Create Free Entry</span>
                        <div class="loading-spinner hidden" id="submitLoader"></div>
                    </button>
                </form>

                <!-- Results -->
                <div id="resultContainer" class="results-container hidden">
                    <h3 style="margin-bottom: 2rem; color: var(--success); font-size: 1.5rem;">‚úÖ Entry Created Successfully!</h3>
                    
                    <div class="link-item">
                        <strong style="color: var(--accent);">üì± Public View Link:</strong>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0.5rem 0;">Share this link with anyone to view your QR entry</p>
                        <div class="link-text" id="viewLink"></div>
                        <button class="btn btn-secondary" onclick="copyToClipboard('viewLink')">Copy Link</button>
                    </div>

                    <div class="link-item">
                        <strong style="color: var(--premium);">üîê Private Edit Link:</strong>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 0.5rem 0;">Keep this secret - allows you to edit the entry</p>
                        <div class="link-text" id="editLink"></div>
                        <button class="btn btn-secondary" onclick="copyToClipboard('editLink')">Copy Edit Link</button>
                    </div>

                    <div class="qr-container">
                        <h4 style="color: var(--accent); margin-bottom: 1rem; font-size: 1.3rem;">üì± Your QR Code</h4>
                        <div id="qrcode" class="qr-code"></div>
                        <button class="btn btn-secondary" id="downloadQR">Download QR Code</button>
                    </div>

                    <div class="share-buttons">
                        <a href="#" id="whatsappShare" class="share-btn whatsapp-btn">üì± Share on WhatsApp</a>
                        <a href="#" id="emailShare" class="share-btn email-btn">üìß Share via Email</a>
                    </div>

                    <div id="expiryInfo" class="expiry-info"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- View Mode -->
    <div id="viewMode" class="hidden">
        <div class="viewer-container">
            <div id="loadingView" class="loading">
                <div class="spinner"></div>
                <p style="color: var(--text-secondary); font-size: 1.2rem;">Loading your entry...</p>
            </div>

            <div id="entryContent" class="viewer-card hidden">
                <div id="planBadge" style="text-align: center; margin-bottom: 1rem;">
                    <span style="background: var(--success); color: white; padding: 0.5rem 1.5rem; border-radius: 25px; font-weight: 600;">Free Plan</span>
                </div>
                
                <h1 class="entry-title" id="entryTitle"></h1>
                <div class="entry-description" id="entryDescription"></div>
                
                <div class="entry-meta">
                    <div class="meta-item" id="contactMeta" style="display: none;">
                        <div class="meta-label">Contact</div>
                        <div class="meta-value" id="entryContact"></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Created</div>
                        <div class="meta-value" id="entryCreated"></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Expires</div>
                        <div class="meta-value" id="entryExpires"></div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Time Left</div>
                        <div class="meta-value" id="timeRemaining"></div>
                    </div>
                </div>

                <div id="fileSection" class="file-section hidden">
                    <h3 style="margin-bottom: 1rem; color: var(--accent);">üìé Attached File</h3>
                    <a href="#" id="fileLink" class="file-link" target="_blank">
                        üìÑ Open File
                    </a>
                </div>

                <div class="actions">
                    <button class="btn btn-secondary" onclick="goHome()">Create New Entry</button>
                </div>
            </div>

            <div id="errorContent" class="error-container hidden">
                <div class="error-icon">‚ùå</div>
                <h2 class="error-title">Entry Not Found</h2>
                <p class="error-message" id="errorMessage">The requested entry could not be found or has expired.</p>
                <button class="btn" onclick="goHome()">Create New Entry</button>
            </div>
        </div>
    </div>

    <!-- Edit Mode -->
    <div id="editMode" class="hidden">
        <div class="viewer-container">
            <div class="viewer-card">
                <h1 style="text-align: center; margin-bottom: 2rem; color: var(--accent); font-size: 2.5rem; font-weight: 800;">Edit Your Entry</h1>
                
                <form id="editForm">
                    <div class="form-group">
                        <label for="editTitle">Title *</label>
                        <input type="text" id="editTitle" name="title" required maxlength="100">
                    </div>

                    <div class="form-group">
                        <label for="editDescription">Description *</label>
                        <textarea id="editDescription" name="description" required maxlength="2000"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editNumber">Contact Number</label>
                        <input type="tel" id="editNumber" name="number" placeholder="+91 9876543210">
                    </div>

                    <div class="form-group">
                        <label for="editFileUrl">File/Website URL</label>
                        <input type="url" id="editFileUrl" name="fileUrl" placeholder="https://example.com/document.pdf">
                    </div>

                    <button type="submit" class="btn">Update Entry</button>
                    <button type="button" class="btn btn-secondary" onclick="goHome()" style="margin-top: 1rem;">Cancel</button>
                </form>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Supabase Configuration (Replace with your actual config)
        const SUPABASE_URL = 'https://plrduifpamfthzvxqcpj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBscmR1aWZwYW1mdGh6dnhxY3BqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NjEzNzksImV4cCI6MjA3MjEzNzM3OX0.5dO5fO-gunEwO5P4CwCM8bC_EwZdQ2NwrQVB7Fdcz2o';
        
        // Razorpay Configuration
        const RAZORPAY_KEY = 'rzp_test_XhqXDzHjQhwJsT';
        
        // Initialize Supabase client
        let supabase;
        if (typeof window.supabase !== 'undefined') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Global variables
        let selectedPlan = 'free';
        let currentMode = 'create';
        let currentEntryId = null;

        // Theme Management
        function initTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');

            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                if (theme === 'light') {
                    themeIcon.textContent = '‚òÄÔ∏è';
                    themeText.textContent = 'Light Mode';
                } else {
                    themeIcon.textContent = 'üåô';
                    themeText.textContent = 'Dark Mode';
                }
            }

            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);

            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                setTheme(newTheme);
            });
        }

        // Utility Functions
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${isError ? 'error' : ''}`;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        function generateId() {
            return 'qr_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateToken() {
            return 'token_' + Date.now() + '_' + Math.random().toString(36).substr(2, 16);
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Link copied to clipboard!');
                }).catch(() => {
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                showToast(successful ? 'Link copied!' : 'Failed to copy', !successful);
            } catch (err) {
                showToast('Failed to copy link', true);
            }
            
            document.body.removeChild(textArea);
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function goHome() {
            window.location.href = window.location.pathname;
        }

        // Database Functions
        async function saveEntry(entryData, plan) {
            try {
                const entryId = generateId();
                const editToken = generateToken();
                const expiryDays = plan === 'premium' ? 30 : 1;
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + expiryDays);

                const entry = {
                    id: entryId,
                    ...entryData,
                    plan: plan,
                    edit_token: editToken,
                    created_at: new Date().toISOString(),
                    expires_at: expiryDate.toISOString(),
                    is_active: true
                };

                if (supabase) {
                    const { data, error } = await supabase
                        .from('qr_entries')
                        .insert([entry])
                        .select();

                    if (error) throw error;
                    return data[0];
                } else {
                    // Fallback to localStorage for demo
                    const entries = JSON.parse(localStorage.getItem('qr_entries') || '{}');
                    entries[entryId] = entry;
                    localStorage.setItem('qr_entries', JSON.stringify(entries));
                    return entry;
                }
            } catch (error) {
                console.error('Save entry error:', error);
                throw error;
            }
        }

        async function getEntry(entryId) {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('qr_entries')
                        .select('*')
                        .eq('id', entryId)
                        .single();

                    if (error) throw new Error('Entry not found');

                    // Check if expired
                    const now = new Date();
                    const expiryDate = new Date(data.expires_at);
                    
                    if (now > expiryDate) {
                        await supabase.from('qr_entries').delete().eq('id', entryId);
                        throw new Error('Entry has expired');
                    }

                    return data;
                } else {
                    // Fallback to localStorage
                    const entries = JSON.parse(localStorage.getItem('qr_entries') || '{}');
                    const entry = entries[entryId];
                    
                    if (!entry) throw new Error('Entry not found');
                    
                    const now = new Date();
                    const expiryDate = new Date(entry.expires_at);
                    
                    if (now > expiryDate) {
                        delete entries[entryId];
                        localStorage.setItem('qr_entries', JSON.stringify(entries));
                        throw new Error('Entry has expired');
                    }
                    
                    return entry;
                }
            } catch (error) {
                console.error('Get entry error:', error);
                throw error;
            }
        }

        async function updateEntry(entryId, entryData, editToken) {
            try {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('qr_entries')
                        .update({
                            ...entryData,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', entryId)
                        .eq('edit_token', editToken)
                        .select();

                    if (error || !data.length) throw new Error('Invalid edit token or entry not found');
                    return data[0];
                } else {
                    // Fallback to localStorage
                    const entries = JSON.parse(localStorage.getItem('qr_entries') || '{}');
                    const entry = entries[entryId];
                    
                    if (!entry || entry.edit_token !== editToken) {
                        throw new Error('Invalid edit token');
                    }
                    
                    entries[entryId] = { ...entry, ...entryData, updated_at: new Date().toISOString() };
                    localStorage.setItem('qr_entries', JSON.stringify(entries));
                    return entries[entryId];
                }
            } catch (error) {
                console.error('Update entry error:', error);
                throw error;
            }
        }

        // Payment Integration
        function processPayment(amount, entryData, onSuccess) {
            if (!window.Razorpay) {
                showToast('Payment system not loaded', true);
                return;
            }

            const options = {
                key: RAZORPAY_KEY,
                amount: amount * 100, // Convert to paise
                currency: 'INR',
                name: 'QR Generator Pro',
                description: 'Premium Plan - 30 Days',
                handler: function(response) {
                    console.log('Payment successful:', response);
                    onSuccess(response);
                },
                prefill: {
                    name: entryData.title,
                    contact: entryData.number || '',
                    email: entryData.email || ''
                },
                theme: {
                    color: '#6366f1'
                },
                modal: {
                    ondismiss: function() {
                        showToast('Payment cancelled', true);
                        setSubmitLoading(false);
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        // WhatsApp/Email Auto-send (Premium Feature)
        async function sendAutoNotifications(entry, viewLink, editLink) {
            if (entry.plan !== 'premium') return;

            const message = `üéâ Your Premium QR Entry is ready!

üìù Title: ${entry.title}
‚è∞ Valid for: 30 days
üîó View Link: ${viewLink}
‚úèÔ∏è Edit Link: ${editLink}

Generated by QR Generator Pro`;

            // WhatsApp (if number provided)
            if (entry.number) {
                const whatsappUrl = `https://wa.me/${entry.number.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }

            // Email (if email provided) - This would need backend service
            // For now, we'll show the share buttons
        }

        // Plan Selection
        function initPlanSelection() {
            const planOptions = document.querySelectorAll('.plan-option');
            const planInfo = document.getElementById('selectedPlanInfo');

            planOptions.forEach(option => {
                option.addEventListener('click', () => {
                    planOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    
                    selectedPlan = option.dataset.plan;
                    updatePlanInfo();
                });
            });
        }

        function updatePlanInfo() {
            const planInfo = document.getElementById('selectedPlanInfo');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');

            if (selectedPlan === 'free') {
                planInfo.innerHTML = '<strong>Selected:</strong> Free Plan (24 hours validity)';
                submitText.textContent = 'Create Free Entry';
                submitBtn.className = 'btn';
            } else {
                planInfo.innerHTML = '<strong>Selected:</strong> Premium Plan (30 days validity + Premium Features)';
                submitText.textContent = 'Create Premium Entry (‚Çπ15)';
                submitBtn.className = 'btn btn-premium';
            }
        }

        // QR Code Generation
        function generateQRCode(text, isPremium = false) {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';

            try {
                const qr = qrcode(0, 'M');
                qr.addData(text);
                qr.make();
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = isPremium ? 250 : 200;
                const moduleSize = size / qr.getModuleCount();
                
                canvas.width = size;
                canvas.height = size;
                
                // Background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, size, size);
                
                // QR modules with custom color for premium
                ctx.fillStyle = isPremium ? '#6366f1' : '#000000';
                for (let row = 0; row < qr.getModuleCount(); row++) {
                    for (let col = 0; col < qr.getModuleCount(); col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(col * moduleSize, row * moduleSize, moduleSize, moduleSize);
                        }
                    }
                }
                
                // Add premium watermark
                if (isPremium) {
                    ctx.fillStyle = '#f59e0b';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('PREMIUM', size / 2, size - 10);
                }
                
                qrContainer.appendChild(canvas);
                setupQRDownload(canvas);
                
            } catch (error) {
                console.error("QR Code generation error:", error);
                qrContainer.innerHTML = '<p style="color: var(--error);">QR Code generation failed</p>';
            }
        }

        function setupQRDownload(canvas) {
            const downloadBtn = document.getElementById('downloadQR');
            downloadBtn.onclick = function() {
                try {
                    const link = document.createElement('a');
                    link.download = `qr-code-${selectedPlan}-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast('QR code downloaded!');
                } catch (error) {
                    showToast('Failed to download QR code', true);
                }
            };
        }

        // Form Submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            setSubmitLoading(true);

            try {
                const formData = new FormData(e.target);
                const entryData = {
                    title: formData.get('title').trim(),
                    description: formData.get('description').trim(),
                    number: formData.get('number')?.trim() || null,
                    fileUrl: formData.get('fileUrl')?.trim() || null
                };

                // Validation
                if (!entryData.title || !entryData.description) {
                    throw new Error('Title and description are required');
                }

                if (entryData.fileUrl && !isValidUrl(entryData.fileUrl)) {
                    throw new Error('Please enter a valid URL');
                }

                // Process payment for premium
                if (selectedPlan === 'premium') {
                    processPayment(15, entryData, async (paymentResponse) => {
                        await createEntry(entryData, 'premium', paymentResponse);
                    });
                } else {
                    await createEntry(entryData, 'free');
                }

            } catch (error) {
                console.error('Form submission error:', error);
                showToast(error.message, true);
                setSubmitLoading(false);
            }
        }

        async function createEntry(entryData, plan, paymentResponse = null) {
            try {
                showToast('Creating your entry...');
                
                const savedEntry = await saveEntry(entryData, plan);
                
                // Display results
                displayResult(savedEntry);
                
                // Send notifications for premium
                if (plan === 'premium') {
                    const baseUrl = window.location.origin + window.location.pathname;
                    const viewLink = `${baseUrl}?id=${savedEntry.id}`;
                    const editLink = `${baseUrl}?edit=${savedEntry.id}&token=${savedEntry.edit_token}`;
                    await sendAutoNotifications(savedEntry, viewLink, editLink);
                }
                
                // Clear form
                document.getElementById('dataForm').reset();
                
                showToast(plan === 'premium' ? 'Premium entry created successfully! üéâ' : 'Free entry created successfully! ‚úÖ');

            } catch (error) {
                console.error('Create entry error:', error);
                showToast('Failed to create entry: ' + error.message, true);
            } finally {
                setSubmitLoading(false);
            }
        }

        function setSubmitLoading(loading) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitLoader = document.getElementById('submitLoader');

            if (loading) {
                submitBtn.disabled = true;
                submitText.style.display = 'none';
                submitLoader.classList.remove('hidden');
            } else {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                submitLoader.classList.add('hidden');
            }
        }

        function displayResult(entry) {
            const baseUrl = window.location.origin + window.location.pathname;
            const viewLink = `${baseUrl}?id=${entry.id}`;
            const editLink = `${baseUrl}?edit=${entry.id}&token=${entry.edit_token}`;

            document.getElementById('viewLink').textContent = viewLink;
            document.getElementById('editLink').textContent = editLink;
            document.getElementById('resultContainer').classList.remove('hidden');

            // Generate QR Code
            generateQRCode(viewLink, entry.plan === 'premium');
            
            // Setup share buttons
            setupShareButtons(entry.title, viewLink, editLink);
            
            // Show expiry info
            const expiryDate = new Date(entry.expires_at);
            const expiryText = entry.plan === 'premium' ? '30 days' : '24 hours';
            document.getElementById('expiryInfo').innerHTML = `
                <strong>‚è∞ Link expires in ${expiryText}</strong><br>
                <span style="font-size: 0.9rem; color: var(--text-secondary);">
                    Expires on: ${expiryDate.toLocaleDateString()} at ${expiryDate.toLocaleTimeString()}
                </span>
            `;

            // Scroll to results
            setTimeout(() => {
                document.getElementById('resultContainer').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 100);
        }

        function setupShareButtons(title, viewLink, editLink) {
            const shareText = `Check out my QR entry: ${title}`;
            
            // WhatsApp share
            const whatsappBtn = document.getElementById('whatsappShare');
            whatsappBtn.href = `https://wa.me/?text=${encodeURIComponent(shareText + '\n\n' + viewLink)}`;
            
            // Email share
            const emailBtn = document.getElementById('emailShare');
            const emailSubject = `QR Entry: ${title}`;
            const emailBody = `${shareText}\n\nView Link: ${viewLink}\n\nEdit Link (Keep Secret): ${editLink}\n\nGenerated by QR Generator Pro`;
            emailBtn.href = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
        }

        // Edit Form Submission
        async function handleEditSubmit(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const entryData = {
                    title: formData.get('title').trim(),
                    description: formData.get('description').trim(),
                    number: formData.get('number')?.trim() || null,
                    fileUrl: formData.get('fileUrl')?.trim() || null
                };

                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');
                const token = urlParams.get('token');

                if (!editId || !token) {
                    throw new Error('Invalid edit parameters');
                }

                showToast('Updating entry...');
                
                await updateEntry(editId, entryData, token);
                
                showToast('Entry updated successfully!');
                
                // Redirect to view mode
                setTimeout(() => {
                    window.location.href = `?id=${editId}`;
                }, 1000);

            } catch (error) {
                console.error('Edit submission error:', error);
                showToast(error.message, true);
            }
        }

        // Mode Management
        function showMode(mode) {
            ['createMode', 'viewMode', 'editMode'].forEach(m => {
                document.getElementById(m).classList.add('hidden');
            });
            document.getElementById(mode).classList.remove('hidden');
            currentMode = mode;
        }

        // View Mode Functions
        async function loadViewMode(entryId) {
            try {
                showMode('viewMode');
                document.getElementById('loadingView').classList.remove('hidden');
                document.getElementById('entryContent').classList.add('hidden');
                document.getElementById('errorContent').classList.add('hidden');

                const entry = await getEntry(entryId);
                displayViewMode(entry);
                
            } catch (error) {
                console.error('View mode error:', error);
                showViewError(error.message);
            }
        }

        function displayViewMode(entry) {
            document.getElementById('loadingView').classList.add('hidden');
            document.getElementById('entryContent').classList.remove('hidden');
            
            // Plan badge
            const planBadge = document.getElementById('planBadge');
            if (entry.plan === 'premium') {
                planBadge.innerHTML = '<span style="background: var(--premium); color: var(--bg-primary); padding: 0.5rem 1.5rem; border-radius: 25px; font-weight: 600;">Premium Plan</span>';
            }
            
            // Fill content
            document.getElementById('entryTitle').textContent = entry.title;
            document.getElementById('entryDescription').textContent = entry.description;
            document.getElementById('entryCreated').textContent = new Date(entry.created_at).toLocaleDateString();
            document.getElementById('entryExpires').textContent = new Date(entry.expires_at).toLocaleDateString();
            
            // Contact info
            if (entry.number) {
                document.getElementById('entryContact').textContent = entry.number;
                document.getElementById('contactMeta').style.display = 'block';
            }

            // File link
            if (entry.fileUrl) {
                document.getElementById('fileLink').href = entry.fileUrl;
                document.getElementById('fileSection').classList.remove('hidden');
            }

            // Time remaining
            const expiryDate = new Date(entry.expires_at);
            const now = new Date();
            const timeLeft = expiryDate.getTime() - now.getTime();
            const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            
            let timeText = 'Expired';
            if (timeLeft > 0) {
                if (daysLeft > 0) {
                    timeText = `${daysLeft}d ${hoursLeft}h left`;
                } else if (hoursLeft > 0) {
                    timeText = `${hoursLeft}h ${minutesLeft}m left`;
                } else {
                    timeText = `${minutesLeft}m left`;
                }
            }
            
            document.getElementById('timeRemaining').textContent = timeText;
        }

        function showViewError(message) {
            document.getElementById('loadingView').classList.add('hidden');
            document.getElementById('entryContent').classList.add('hidden');
            document.getElementById('errorContent').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Edit Mode Functions
        async function loadEditMode(entryId, token) {
            try {
                showMode('editMode');
                
                const entry = await getEntry(entryId);
                
                if (entry.edit_token !== token) {
                    throw new Error('Invalid edit token');
                }

                // Prefill form
                document.getElementById('editTitle').value = entry.title || '';
                document.getElementById('editDescription').value = entry.description || '';
                document.getElementById('editNumber').value = entry.number || '';
                document.getElementById('editFileUrl').value = entry.fileUrl || '';
                
            } catch (error) {
                console.error('Edit mode error:', error);
                showToast(error.message, true);
                goHome();
            }
        }

        // Route Management
        function checkRoute() {
            const urlParams = new URLSearchParams(window.location.search);
            const entryId = urlParams.get('id');
            const editId = urlParams.get('edit');
            const editToken = urlParams.get('token');

            if (editId && editToken) {
                loadEditMode(editId, editToken);
            } else if (entryId) {
                loadViewMode(entryId);
            } else {
                showMode('createMode');
            }
        }

        // Initialize Application
        function initializeApp() {
            console.log('Initializing QR Generator Pro...');
            
            // Initialize theme
            initTheme();
            
            // Initialize plan selection
            initPlanSelection();
            
            // Setup form submissions
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
            
            // Check route and show appropriate mode
            checkRoute();
            
            console.log('App initialized successfully');
        }

        // Auto-cleanup expired entries (runs every hour)
        async function cleanupExpiredEntries() {
            try {
                if (supabase) {
                    const now = new Date().toISOString();
                    await supabase
                        .from('qr_entries')
                        .delete()
                        .lt('expires_at', now);
                } else {
                    // Cleanup localStorage
                    const entries = JSON.parse(localStorage.getItem('qr_entries') || '{}');
                    const now = new Date();
                    let cleaned = false;

                    Object.keys(entries).forEach(id => {
                        const entry = entries[id];
                        const expiryDate = new Date(entry.expires_at);
                        
                        if (now > expiryDate) {
                            delete entries[id];
                            cleaned = true;
                        }
                    });

                    if (cleaned) {
                        localStorage.setItem('qr_entries', JSON.stringify(entries));
                    }
                }
                
                console.log('Cleanup completed');
            } catch (error) {
                console.error('Cleanup error:', error);
            }
        }

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeApp, 500);
            
            // Run cleanup every hour
            setInterval(cleanupExpiredEntries, 60 * 60 * 1000);
            
            // Run initial cleanup
            cleanupExpiredEntries();
        });

        // Handle navigation
        window.addEventListener('popstate', checkRoute);
    </script>
</body>
</html>